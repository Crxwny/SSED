<!doctype html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alle HTML5 Input-Typen mit Parsley.js Validierung</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/parsleyjs@2.9.2/dist/parsley.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/parsleyjs@2.9.2/dist/i18n/de.js"></script>
    <style>
        .hidden { display: none; }
        .form-section {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .form-section h4 {
            color: #495057;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .required::after {
            content: " *";
            color: red;
        }
        .volume-display {
            font-weight: bold;
            color: #0d6efd;
        }
        .color-preview {
            width: 100px;
            height: 50px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            margin-top: 10px;
            display: inline-block;
        }
        .file-preview {
            margin-top: 10px;
            max-width: 200px;
        }
        .file-preview img {
            max-width: 100%;
            border-radius: 5px;
            border: 2px solid #dee2e6;
        }
        .file-info {
            margin-top: 5px;
            font-size: 0.875rem;
            color: #6c757d;
        }
        .parsley-errors-list {
            margin-top: 0.25rem;
            margin-bottom: 0;
            padding-left: 0;
            list-style: none;
        }
        .parsley-errors-list li {
            color: #dc3545;
            font-size: 0.875rem;
        }
        .parsley-error {
            border-color: #dc3545;
        }
        .parsley-success {
            border-color: #198754;
        }
    </style>
</head>
<body class="p-4 bg-light">

<div class="container">
    <h1 class="text-center mb-4">Alle HTML5 Input-Typen mit Parsley.js</h1>

    <div id="form-message" class="alert mb-3" style="display: none;"></div>

    <form id="demo-form" data-parsley-validate class="bg-white p-4 rounded shadow-sm">

        <div class="form-section">
            <h4>Text-basierte Eingaben</h4>

            <!-- text -->
            <div class="mb-3">
                <label for="fullname" class="form-label required">Vollständiger Name</label>
                <input type="text" id="fullname" class="form-control" name="fullname"
                       required 
                       data-parsley-minlength="2" 
                       data-parsley-maxlength="50"
                       data-parsley-pattern="^[a-zA-ZäöüÄÖÜß\s]+$"
                       data-parsley-minlength-message="Mindestens 2 Zeichen erforderlich"
                       data-parsley-maxlength-message="Maximal 50 Zeichen erlaubt"
                       data-parsley-pattern-message="Nur Buchstaben und Leerzeichen erlaubt">
                <div class="form-text">Mindestens 2 Zeichen, maximal 50 Zeichen</div>
            </div>

            <!-- password -->
            <div class="mb-3">
                <label for="password" class="form-label required">Passwort</label>
                <input type="password" id="password" class="form-control" name="password"
                       required 
                       data-parsley-minlength="6" 
                       data-parsley-pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).+$"
                       data-parsley-pattern-message="Mindestens 6 Zeichen, Groß- und Kleinbuchstaben sowie eine Zahl erforderlich">
                <div class="form-text">Mindestens 6 Zeichen, Groß- und Kleinbuchstaben sowie eine Zahl</div>
            </div>

            <!-- email -->
            <div class="mb-3">
                <label for="email" class="form-label required">E-Mail</label>
                <input type="email" id="email" class="form-control" name="email" 
                       required
                       data-parsley-type="email"
                       data-parsley-type-message="Bitte geben Sie eine gültige E-Mail-Adresse ein">
            </div>

            <!-- url -->
            <div class="mb-3">
                <label for="website" class="form-label required">Webseite</label>
                <input type="url" id="website" class="form-control" name="website" required
                       data-parsley-type="url"
                       data-parsley-type-message="Bitte geben Sie eine gültige URL ein (z.B. https://example.com)">
            </div>

            <!-- tel -->
            <div class="mb-3">
                <label for="phone" class="form-label required">Telefon</label>
                <input type="tel" id="phone" class="form-control" name="phone" required
                       data-parsley-pattern="^[\+]?[0-9\s\-\(\)]{6,}$"
                       data-parsley-pattern-message="Gültige Telefonnummer mit mindestens 6 Ziffern erforderlich">
                <div class="form-text">Gültige Telefonnummer mit mindestens 6 Ziffern</div>
            </div>

            <!-- search -->
            <div class="mb-3">
                <label for="search" class="form-label required">Suche</label>
                <input type="search" id="search" class="form-control" name="search" required
                       data-parsley-maxlength="100"
                       data-parsley-maxlength-message="Maximal 100 Zeichen erlaubt">
            </div>
        </div>

        <div class="form-section">
            <h4>Numerische Eingaben</h4>

            <!-- number -->
            <div class="mb-3">
                <label for="quantity" class="form-label required">Menge (1-10)</label>
                <input type="number" id="quantity" class="form-control" name="quantity"
                       min="1" max="10" required
                       data-parsley-type="number"
                       data-parsley-min="1"
                       data-parsley-max="10"
                       data-parsley-min-message="Mindestens 1 erforderlich"
                       data-parsley-max-message="Maximal 10 erlaubt">
            </div>

            <!-- range -->
            <div class="mb-3">
                <label for="volume" class="form-label required">Lautstärke (0-100): <span id="volume-value" class="volume-display">50</span></label>
                <input type="range" id="volume" class="form-range" name="volume"
                       min="0" max="100" value="50" required
                       data-parsley-range="[0, 100]"
                       data-parsley-range-message="Wert muss zwischen 0 und 100 liegen">
            </div>
        </div>

        <div class="form-section">
            <h4>Datum und Zeit</h4>

            <!-- date -->
            <div class="mb-3">
                <label for="birthday" class="form-label required">Geburtstag</label>
                <input type="date" id="birthday" class="form-control" name="birthday" required
                       data-parsley-max=""
                       data-parsley-max-message="Das Datum darf nicht in der Zukunft liegen">
                <div class="form-text">Darf nicht in der Zukunft liegen</div>
            </div>

            <!-- datetime-local -->
            <div class="mb-3">
                <label for="appointment" class="form-label required">Termin</label>
                <input type="datetime-local" id="appointment" class="form-control" name="appointment" required
                       data-parsley-futuredatetime="true"
                       data-parsley-futuredatetime-message="Das Datum muss in der Zukunft liegen">
                <div class="form-text">Muss in der Zukunft liegen</div>
            </div>

            <!-- month -->
            <div class="mb-3">
                <label for="month" class="form-label required">Monat (YYYY-MM)</label>
                <input type="month" id="month" name="month" class="form-control mb-2" required
                       data-parsley-pattern="^\d{4}-(0[1-9]|1[0-2])$"
                       data-parsley-pattern-message="Bitte geben Sie einen gültigen Monat ein (YYYY-MM)">
                <input type="date" id="month-calendar" class="form-control calendar-helper"
                       aria-label="Kalender für Monatsauswahl" data-parsley-excluded="true">
                <div class="form-text">Kalenderauswahl überträgt das Jahr und den Monat in das Feld.</div>
            </div>

            <!-- week -->
            <div class="mb-3">
                <label for="week" class="form-label required">Woche (YYYY-Www)</label>
                <input type="week" id="week" name="week" class="form-control mb-2" required
                       data-parsley-pattern="^\d{4}-W(0[1-9]|[1-4][0-9]|5[0-3])$"
                       data-parsley-pattern-message="Bitte geben Sie eine gültige Woche ein (YYYY-Www)">
                <input type="date" id="week-calendar" class="form-control calendar-helper"
                       aria-label="Kalender für Wochenauswahl" data-parsley-excluded="true">
                <div class="form-text">Kalendereingabe bestimmt die ISO-Woche.</div>
            </div>

        </div>

        <div class="form-section">
            <h4>Auswahl und Dateien</h4>

            <!-- color -->
            <div class="mb-3">
                <label for="favcolor" class="form-label required">Lieblingsfarbe</label><br>
                <input type="color" id="favcolor" class="form-control form-control-color" name="favcolor" value="#563d7c" required>
                <div class="color-preview" id="color-preview" style="background-color: #563d7c;"></div>
                <div class="form-text">Ausgewählte Farbe: <span id="color-value">#563d7c</span></div>
            </div>

            <!-- file -->
            <div class="mb-3">
                <label for="fileUpload" class="form-label required">Datei hochladen</label>
                <input type="file" id="fileUpload" class="form-control" name="fileUpload" required
                       accept="image/png,image/jpeg" 
                       data-parsley-filemaxmegabytes="2"
                       data-parsley-accept="png,jpg"
                       data-parsley-fileextensions="jpg,jpeg,png">
                <div class="file-preview" id="file-preview"></div>
                <div class="file-info" id="file-info"></div>
                <div class="form-text">Erlaubte Dateitypen: PNG, JPG. Maximal 2 MB.</div>
            </div>

            <!-- radio -->
            <div class="mb-3">
                <label class="form-label required">Geschlecht</label><br>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" id="male" name="gender" value="male" required>
                    <label class="form-check-label" for="male">Männlich</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" id="female" name="gender" value="female">
                    <label class="form-check-label" for="female">Weiblich</label>
                </div>
                <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" id="other" name="gender" value="other">
                    <label class="form-check-label" for="other">Andere</label>
                </div>
            </div>

            <!-- checkbox -->
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="agree" name="agree" required>
                    <label class="form-check-label required" for="agree">Ich stimme den AGB zu</label>
                </div>
            </div>
        </div>

        <div class="form-section">
            <h4>Buttons und spezielle Elemente</h4>

            <!-- button -->
            <div class="mb-3">
                <button type="button" class="btn btn-secondary" id="myButton">Klick mich</button>
                <div class="form-text">Dieser Button hat keine Standard-Funktionalität</div>
            </div>

            <!-- image -->
            <div class="mb-3">
                <label class="form-label">Bild-Button</label><br>
                <input type="image" id="imageSubmit" src="https://placehold.co/600x400/563d7c/ffffff?text=Absenden" 
                       alt="Absenden" width="120" height="40">
                <div class="form-text">Funktioniert wie ein Submit-Button</div>
            </div>

            <!-- reset -->
            <div class="mb-3">
                <input type="reset" class="btn btn-warning" value="Formular zurücksetzen">
                <div class="form-text">Setzt alle Felder auf ihre Standardwerte zurück</div>
            </div>

            <!-- hidden -->
            <input type="hidden" id="token" name="token" value="">
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <input type="submit" id="formSubmit" class="btn btn-primary" value="Absenden">
        </div>
    </form>
</div>

<script>
    $(function () {
        const allowedImageMimeTypes = ['image/png', 'image/jpeg'];
        const allowedImageExtensions = ['png', 'jpg', 'jpeg'];

        function formatLocalDate(date) {
            const tzOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() - tzOffset).toISOString().split('T')[0];
        }

        function formatLocalDateTime(date) {
            const tzOffset = date.getTimezoneOffset() * 60000;
            return new Date(date.getTime() - tzOffset).toISOString().slice(0, 16);
        }

        function isAllowedImageFile(file) {
            if (!file) {
                return false;
            }
            if (file.type && allowedImageMimeTypes.includes(file.type.toLowerCase())) {
                return true;
            }
            const extension = file.name.split('.').pop().toLowerCase();
            return allowedImageExtensions.includes(extension);
        }

        function getISOWeekString(dateString) {
            if (!dateString) {
                return '';
            }
            const date = new Date(dateString);
            date.setHours(0, 0, 0, 0);
            // ISO week: Thursday determines week number
            const dayNum = (date.getDay() + 6) % 7;
            date.setDate(date.getDate() + 3 - dayNum);
            const firstThursday = new Date(date.getFullYear(), 0, 4);
            const weekNumber = Math.round(((date.getTime() - firstThursday.getTime()) / 86400000 - 3 + ((firstThursday.getDay() + 6) % 7)) / 7) + 1;
            const weekStr = weekNumber < 10 ? '0' + weekNumber : weekNumber;
            return `${date.getFullYear()}-W${weekStr}`;
        }

        function setupCalendarSync(calendarSelector, targetSelector, transformFn) {
            const calendar = document.querySelector(calendarSelector);
            const target = document.querySelector(targetSelector);
            if (!calendar || !target) {
                return;
            }
            calendar.addEventListener('change', function () {
                if (!calendar.value) {
                    return;
                }
                const transformed = transformFn(calendar.value);
                if (!transformed) {
                    return;
                }
                target.value = transformed;
                target.dispatchEvent(new Event('input', { bubbles: true }));
                target.dispatchEvent(new Event('change', { bubbles: true }));
            });
        }

        function updateDateConstraints() {
            const now = new Date();
            const maxDate = formatLocalDate(now);
            $('#birthday').attr('max', maxDate).attr('data-parsley-max', maxDate);
        }

        // ============================================
        // Custom Parsley Validatoren - MÜSSEN VOR der Initialisierung definiert werden
        // ============================================

        // Custom Validator für Dateiupload-Größe
        window.Parsley.addValidator('filemaxmegabytes', {
            validateString: function(_value, maxMegabytes, parsleyInstance) {
                if (!window.FormData) {
                    return true; // Fallback für ältere Browser
                }
                var files = parsleyInstance.$element[0].files;
                if (files.length == 0) {
                    return true; // Keine Datei ausgewählt
                }
                return files[0].size <= maxMegabytes * 1024 * 1024;
            },
            requirementType: 'integer',
            messages: {
                de: 'Die Datei darf maximal %s MB groß sein.'
            }
        });

        // Custom Validator für Dateityp
        window.Parsley.addValidator('accept', {
            validateString: function(_value, acceptType, parsleyInstance) {
                if (!window.FormData) {
                    return true; // Fallback für ältere Browser
                }
                var files = parsleyInstance.$element[0].files;
                if (files.length == 0) {
                    return true; // Keine Datei ausgewählt
                }

                var file = files[0];
                if (acceptType === 'png,jpg') {
                    return isAllowedImageFile(file);
                }

                return true;
            },
            messages: {
                de: 'Bitte wählen Sie eine PNG- oder JPG-Datei aus.'
            }
        });

        // Custom Validator für Datei-Endungen
        window.Parsley.addValidator('fileextensions', {
            validateString: function(_value, extensions, parsleyInstance) {
                if (!window.FormData) {
                    return true;
                }
                const files = parsleyInstance.$element[0].files;
                if (!files.length) {
                    return true;
                }
                const file = files[0];
                const allowed = extensions.split(',').map(function(ext) { return ext.trim().toLowerCase(); });
                const fileExt = file.name.split('.').pop().toLowerCase();
                return allowed.includes(fileExt);
            },
            requirementType: 'string',
            messages: {
                de: 'Nur Dateien mit den Endungen %s sind erlaubt.'
            }
        });

        // Custom Validator für Termin in der Zukunft
        window.Parsley.addValidator('futuredatetime', {
            validateString: function(value) {
                if (!value) {
                    return true;
                }
                const date = new Date(value);
                if (isNaN(date.getTime())) {
                    return false;
                }
                return date.getTime() > Date.now();
            },
            priority: 32,
            messages: {
                de: 'Bitte wählen Sie einen Termin in der Zukunft.'
            }
        });

        // Parsley.js deutsche Lokalisierung aktivieren
        window.Parsley.setLocale('de');
        
        // Dynamische Datumswerte setzen
        updateDateConstraints();
        setInterval(updateDateConstraints, 60 * 1000);

        setupCalendarSync('#month-calendar', '#month', function (value) {
            return value ? value.slice(0, 7) : '';
        });
        setupCalendarSync('#week-calendar', '#week', function (value) {
            return getISOWeekString(value);
        });
        $('#appointment, #birthday').on('focus', updateDateConstraints);
        
        // Parsley.js Konfiguration - NACH den Custom Validatoren
        const $form = $('#demo-form');
        const parsleyForm = $form.parsley({
            trigger: 'change',
            triggerAfterFailure: 'input',
            errorClass: 'is-invalid',
            successClass: 'is-valid',
            errorsWrapper: '<ul class="parsley-errors-list"></ul>',
            errorTemplate: '<li class="parsley-required"></li>'
        });

        // Funktion zum Anzeigen von Meldungen
        function showFormMessage(message, type) {
            const $message = $('#form-message');
            $message.removeClass('alert-success alert-danger');
            $message.addClass(type === 'success' ? 'alert-success' : 'alert-danger');
            $message.text(message);
            $message.fadeIn();
            
            // Zum Anfang der Seite scrollen, damit die Meldung sichtbar ist
            $('html, body').animate({ scrollTop: 0 }, 300);
            
            // Nach 5 Sekunden ausblenden
            setTimeout(function() {
                $message.fadeOut();
            }, 5000);
        }

        // Flag um zu unterscheiden ob Reset programmatisch oder durch Button erfolgt
        let isProgrammaticReset = false;

        // ==== Submit Handler ====
        $form.on('submit', function(e) {
            e.preventDefault(); // verhindert echtes Submit

            parsleyForm.validate({ force: true });

            if (!parsleyForm.isValid({ force: true })) {
                showFormMessage('Bitte korrigieren Sie die Fehler im Formular.', 'error');
                return; // ⛔ STOP - nicht absenden
            }

            // Formular ist gültig – jetzt absenden
            rotateSubmitImage();
            showFormMessage('Formular erfolgreich validiert!', 'success');
            
            // Programmatisches Reset - Flag setzen
            isProgrammaticReset = true;
            $form[0].reset();
            parsleyForm.reset();
            updateHiddenToken();
            updateDateConstraints();
            isProgrammaticReset = false;
        });

        // ============================================
        // JAVASCRIPT für Elemente die es benötigen:
        // ============================================

        // 1. RANGE: Slider-Wert anzeigen
        $('#volume').on('input', function() {
            $('#volume-value').text(this.value);
        });

        // 2. COLOR: Farbvorschau und Wert anzeigen
        $('#favcolor').on('input', function() {
            const colorValue = this.value;
            $('#color-preview').css('background-color', colorValue);
            $('#color-value').text(colorValue);
        });

        // 3. FILE: Dateivorschau, Größenprüfung, Drag & Drop
        const $fileUpload = $('#fileUpload');
        $fileUpload.on('change', function(e) {
            const file = e.target.files[0];
            const preview = $('#file-preview');
            const info = $('#file-info');
            
            preview.empty();
            info.empty();
            
            if (file) {
                if (!isAllowedImageFile(file)) {
                    info.html('<span class="text-danger">Nur PNG- oder JPG-Dateien sind erlaubt.</span>');
                    $(this).val('');
                    $(this).parsley().validate();
                    return;
                }

                // Größenprüfung (in MB)
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                info.html(`Dateiname: ${file.name}<br>Größe: ${fileSizeMB} MB<br>Typ: ${file.type || 'unbekannt'}`);
                
                // Dateivorschau für Bilder
                if ((file.type && file.type.startsWith('image/')) || isAllowedImageFile(file)) {
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        preview.html(`<img src="${ev.target.result}" alt="Vorschau">`);
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        // RESET: Farbe und Bild zurücksetzen
        $('#demo-form').on('reset', function() {
            // Nur Meldung anzeigen wenn Reset durch Button erfolgt (nicht programmatisch)
            if (!isProgrammaticReset) {
                showFormMessage('Formular wurde zurückgesetzt.', 'success');
            }
            setTimeout(function() {
                // Farbe zurücksetzen
                $('#favcolor').val('#563d7c');
                $('#color-preview').css('background-color', '#563d7c');
                $('#color-value').text('#563d7c');
                
                // Datei zurücksetzen
                $('#fileUpload').val('');
                $('#file-preview').empty();
                $('#file-info').empty();
            }, 0);
        });

        // Drag & Drop für File-Input
        const fileInput = $('#fileUpload')[0];
        const fileContainer = $('#fileUpload').closest('.mb-3');
        
        fileContainer.on('dragover', function(e) {
            e.preventDefault();
            $(this).addClass('border border-primary');
        });
        
        fileContainer.on('dragleave', function(e) {
            e.preventDefault();
            $(this).removeClass('border border-primary');
        });
        
        fileContainer.on('drop', function(e) {
            e.preventDefault();
            $(this).removeClass('border border-primary');
            const files = e.originalEvent.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                $('#fileUpload').trigger('change');
            }
        });

        // 4. BUTTON: Interaktive Funktionen
        $('#myButton').on('click', function() {
            const currentTime = new Date().toLocaleTimeString('de-DE');
            alert(`Button wurde um ${currentTime} geklickt!\n\nDiese Funktion könnte beliebigen JavaScript-Code ausführen.`);
        });

        // 5. IMAGE: Bildwechsel und interaktive Funktionen
        let imageIndex = 0;
        const images = [
            'https://placehold.co/600x400/563d7c/ffffff?text=Absenden',
            'https://placehold.co/600x400/198754/ffffff?text=Submit',
            'https://placehold.co/600x400/dc3545/ffffff?text=Send'
        ];
        
        function rotateSubmitImage() {
            imageIndex = (imageIndex + 1) % images.length;
            $('#imageSubmit').attr('src', images[imageIndex]);
        }

        // 6. HIDDEN: Dynamisches Setzen von Werten
        function updateHiddenToken() {
            const timestamp = new Date().toISOString();
            const randomToken = Math.random().toString(36).substring(2, 15);
            $('#token').val('token_' + timestamp + '_' + randomToken);
        }
        
        // Token beim Laden setzen
        updateHiddenToken();
        
        // Token bei jedem Feld-Change aktualisieren
        $('#demo-form').on('change', 'input, select, textarea', function() {
            updateHiddenToken();
        });
    });
</script>

</body>
</html>

